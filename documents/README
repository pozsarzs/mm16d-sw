Operating program for MM16D device
----------------------------------

1. About software
~~~~~~~~~~~~~~~~~

  It is a stand-alone grow house control device. It takes the environmental data
from the MM17D connected to it via the serial port using Modbus/RTU protocol.
Default serial port parameters for serial console and Modbus/RTU connection: 9600
bps, 8N1. It uploads the received data and the status data of the device to a
remote database, and also retrieves the settings affecting its operation from
there. If this database is not available, it works with the last or a general
setting (if it is after switching on), then the logging is paused.
  It has a web interface. All data can be queried via WLAN using HTTP in four
formats (CSV, JSON, TXT and XML) and using Modbus/TCP.
 
Requirements:
  Hardware: ESP8266 Huzzah Feather microcontroller
  Software: - Modbus-ESP8266 library v4.1.0 by Andre Sarmento Barbosa,
              Alexander Emelianov
            - NTPClient library v3.2.1 by Fabrice Weinberg
            - ESP8266WebServer library v1.0 by Ivan Grokhotkov
            - ESP8266WiFi library v1.0 by Ivan Grokhotkov
            - StringSplitter library v1.0.0 by Harsha Alva

2. Settings
~~~~~~~~~~~
In the 'mm16d.ino' file:

  // settings
  const int     COM_SPEED                 = 9600;
  const char   *NTPSERVER                 = "europe.pool.ntp.org";
  const char   *WIFI_SSID                 = "";
  const char   *WIFI_PASSWORD             = "";
  const int     MB_UID                    = 1; // slave device UID

3. Serial console output
~~~~~~~~~~~~~~~~~~~~~~~~
The serial console shuts down at the end of the startup process to free the
serial port for Modbus/RTU communication.

MM16D * Grow house controller
  Copyright (C) 2023 Pozsar Zsolt
    software version:       v0.1.0
  Starting device...
  * Initializing GPIO ports
  * Connecting to wireless network.......done
    my MAC address:         80:7D:3A:5D:53:84
    my IP address:          192.168.0.103
    subnet mask:            255.255.255.0
    gateway IP address:     192.168.0.1
  * Starting NTP client
  * Starting Modbus/TCP server
  * Starting Modbus/RTU master
    serial port speed:      9600
    client Modbus UID:      1
  * Starting webserver
  * Ready, the serial console is off.
  
4. Information and data access
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
a. Information pages:
  http://../          help                                       text/html
  http://../summary   summary                                    text/html
  http://../log       log                                        text/html

b. Data access with HTTP:
  http://../get/csv   all values in CSV format                   text/plain
  http://../get/json  all values in JSON format                  text/plain
  http://../get/txt   all values in TXT format                   text/plain
  http://../get/xml   all values in XML format                   text/plain

  Output format:
  CSV:
    "name","MM16D"
    "version","0.1.0"
    "mac_address","EC:FA:BC:C1:0A:72"
    "ip_address","192.168.0.245"
    "modbus_uid","1"
    "com_speed","9600"
    "enable_channels","0"
    "hheater_disable1","0"
    "hheater_disable2","0"
    "hheater_on","0"
    "hheater_off","0"
    "htemperature_min","0"
    "htemperature_max","0"
    "hhumidity_min","0"
    "hhumidity_max","0"
    "mheater_disable1","0"
    "mheater_disable2","0"
    "mvent_disable1","0"
    "mvent_disable2","0"
    "mvent_disablehightemp1","0"
    "mvent_disablehightemp2","0"
    "mvent_disablelowtemp1","0"
    "mvent_disablelowtemp2","0"
    "mheater_on","0"
    "mheater_off","0"
    "mtemperature_min","0"
    "mtemperature_max","0"
    "mhumidity_min","0"
    "mhumidity_max","0"
    "mlight_off","0"
    "mlight_on","0"
    "mvent_on","0"
    "mvent_off","0"
    "mvent_hightemp","0"
    "mvent_lowtemp","0"
    "mm17drhint","0"
    "mm17dtint","0"
    "mm17dtext","0"
    "signlight","0"
    "alarm","1"
    "breaker","1"
    "errorntp","0"
    "errormm17d","0"
    "standby","1"
    "hyphae","0"
    "mushroom","0"
    "manual","1"
    "ena_lamp","1"
    "ena_vent","0"
    "ena_heater","0"
    "lamp","0"
    "vent","0"
    "heater","0"
    "rhintless","0"
    "rhintmore","0"
    "tintless","0"
    "tintmore","0"
    "mm17dgreen","0"
    "mm17dyellow","0"
    "mm17dred","0"
 
  TXT:
    MM17D
    0.1.0
    80:7D:3A:5D:53:84
    192.168.0.103
    1
    9600
    1
    0
    0
    0
    0
    0
    {...}
    1
    0
    0

  JSON:
{
    "software": {
        "name": "MM16D",
        "version": "0.1.0"
    },
    "hardware": {
        "mac_address": "EC:FA:BC:C1:0A:72",
        "ip_address": "192.168.0.245",
        "modbus_uid": "1",
        "com_speed": "9600"
    },
    "settings": {
        "integer": {
            "enable_channels": "0",
            "hheater_disable1": "0",
            "hheater_disable2": "0",
            "hheater_on": "0",
            "hheater_off": "0",
            "htemperature_min": "0",
            "htemperature_max": "0",
            "hhumidity_min": "0",
            "hhumidity_max": "0",
            "mheater_disable1": "0",
            "mheater_disable2": "0",
            "mvent_disable1": "0",
            "mvent_disable2": "0",
            "mvent_disablehightemp1": "0",
            "mvent_disablehightemp2": "0",
            "mvent_disablelowtemp1": "0",
            "mvent_disablelowtemp2": "0",
            "mheater_on": "0",
            "mheater_off": "0",
            "mtemperature_min": "0",
            "mtemperature_max": "0",
            "mhumidity_min": "0",
            "mhumidity_max": "0",
            "mlight_off": "0",
            "mlight_on": "0",
            "mvent_on": "0",
            "mvent_off": "0",
            "mvent_hightemp": "0",
            "mvent_lowtemp": "0"
        }
    },
    "data": {
        "integer": {
            "mm17drhint": "0",
            "mm17dtint": "0",
            "mm17dtext": "0"
        },
        "bit": {
            "signlight": "0",
            "alarm": "0",
            "breaker": "0",
            "errorntp": "0",
            "errormm17d": "0",
            "standby": "0",
            "hyphae": "0",
            "mushroom": "0",
            "manual": "0",
            "ena_lamp": "0",
            "ena_vent": "0",
            "ena_heater": "0",
            "lamp": "0",
            "vent": "0",
            "heater": "0",
            "rhintless": "0",
            "rhintmore": "0",
            "tintless": "0",
            "tintmore": "0",
            "mm17dgreen": "0",
            "mm17dyellow": "0",
            "mm17dred": "0"
        }
    }
}

  XML:
<xml>
  <software>
    <name>MM16D</name>
    <version>0.1.0</version>
  </software>
  <hardware>
    <mac_address>EC:FA:BC:C1:0A:72</mac_address>
    <ip_address>192.168.0.245</ip_address>
    <modbus_uid>1</modbus_uid>
    <com_speed>9600</com_speed>
  </hardware>
  <settings>
      <enable_channels>0</enable_channels>
      <hheater_disable1>0</hheater_disable1>
      <hheater_disable2>0</hheater_disable2>
      <hheater_on>0</hheater_on>
      <hheater_off>0</hheater_off>
      <htemperature_min>0</htemperature_min>
      <htemperature_max>0</htemperature_max>
      <hhumidity_min>0</hhumidity_min>
      <hhumidity_max>0</hhumidity_max>
      <mheater_disable1>0</mheater_disable1>
      <mheater_disable2>0</mheater_disable2>
      <mvent_disable1>0</mvent_disable1>
      <mvent_disable2>0</mvent_disable2>
      <mvent_disablehightemp1>0</mvent_disablehightemp1>
      <mvent_disablehightemp2>0</mvent_disablehightemp2>
      <mvent_disablelowtemp1>0</mvent_disablelowtemp1>
      <mvent_disablelowtemp2>0</mvent_disablelowtemp2>
      <mheater_on>0</mheater_on>
      <mheater_off>0</mheater_off>
      <mtemperature_min>0</mtemperature_min>
      <mtemperature_max>0</mtemperature_max>
      <mhumidity_min>0</mhumidity_min>
      <mhumidity_max>0</mhumidity_max>
      <mlight_off>0</mlight_off>
      <mlight_on>0</mlight_on>
      <mvent_on>0</mvent_on>
      <mvent_off>0</mvent_off>
      <mvent_hightemp>0</mvent_hightemp>
      <mvent_lowtemp>0</mvent_lowtemp>
  </settings>
  <data>
    <integer>
      <mm17drhint>0</mm17drhint>
      <mm17dtint>0</mm17dtint>
      <mm17dtext>0</mm17dtext>
    </integer>
    <bit>
      <signlight>0</signlight>
      <alarm>1</alarm>
      <breaker>1</breaker>
      <errorntp>0</errorntp>
      <errormm17d>0</errormm17d>
      <standby>1</standby>
      <hyphae>0</hyphae>
      <mushroom>0</mushroom>
      <manual>1</manual>
      <ena_lamp>1</ena_lamp>
      <ena_vent>0</ena_vent>
      <ena_heater>0</ena_heater>
      <lamp>0</lamp>
      <vent>0</vent>
      <heater>0</heater>
      <rhintless>0</rhintless>
      <rhintmore>0</rhintmore>
      <tintless>0</tintless>
      <tintmore>0</tintmore>
      <mm17dgreen>0</mm17dgreen>
      <mm17dyellow>0</mm17dyellow>
      <mm17dred>0</mm17dred>
    </bit>
  </data>
 </xml>
 
c.Data access with Modbus:

  Status (RO):
  10001               Sign lights              (0/1: red/green)  bit
  10002               Alarm                 (0/1: normal/alarm)  bit
  10003               Overcurrent breaker  (0/1: closed/opened)  bit
  10004               No connection to the NTP server            bit
  10005               No connection to the MM17D                 bit
  10006               Stand-by operation mode                    bit
  10007               Growing hyphae operation mode              bit
  10008               Growing mushroom operation mode            bit
  10009               Manual switch               (0/1: off/on)  bit
  10010               Enable lamp output            (1: enable)  bit
  10011               Enable ventilator output      (1: enable)  bit
  10012               Enable heater output          (1: enable)  bit
  10013               Lamp output                 (0/1: off/on)  bit
  10014               Ventilator output           (0/1: off/on)  bit
  10015               Heater output               (0/1: off/on)  bit
  10016               Internal humidity is less than requied     bit
  10017               Internal humidity is more than requied     bit
  10018               Internal temperature is less than requied  bit
  10019               Internal temperature is more than requied  bit
  10020               MM17D green LED             (0/1: off/on)  bit
  10021               MM17D yellow LED            (0/1: off/on)  bit
  10022               MM17D red LED               (0/1: off/on)  bit

  Measured values (RO):
  30001               MM17D int. humidity in percent             uint16
  30002               MM17D int. temperature in Kelvin           uint16
  30003               MM17D ext. temperature in Kelvin           uint16

  Configuration (RO):
  40001-40008         device name                  8 ASCII coded char
  40009-40011         software version                         3 byte
  40012-40017         MAC address                              6 byte
  40018-40021         IP address                               4 byte
  40022               Modbus UID                                 integer
  40023-40028         serial port speed            6 ASCII coded char

  Settings (R/W):
  40101               enable/disable channels                          3 bit


/*

  40102-40103         time-dependent heating prohibition in h      = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };
  40104               heating switch-on temperature in Kelvin
  40105               heating switch-off temperature in Kelvin
  40106               	minimum temperature in Kelvin
  40107               htemperature_max          = 25; // in Kelvin
  40118               hhumidity_min             = 85; // in percent
  40119               hhumidity_max             = 95; // in percent
  40110-40111         mheater_disable[24]       = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };
  40112-40113         mvent_disable[24]         = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };
  40114-40115         mvent_disablehightemp[24] = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };
  40116-40117         mvent_disablelowtemp[24]  = { 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0 };
  40118               mheater_on                = 14; // in Kelvin
  40119               mheater_off               = 16; // in Kelvin
  40120               mtemperature_min          = 8;  // in Kelvin
  40121               mtemperature_max          = 18; // in Kelvin
  40122               mhumidity_min             = 85; // in percent
  40123               mhumidity_max             = 95; // in percent
  40124               mlight_off                = 22; // in hour
  40125               mlight_on                 = 14; // in hour
  40126               mvent_on                  = 15; // in minute
  40127               mvent_off                 = 30; // in minute
  40128               mvent_hightemp            = 30; // in Kelvin
  40129               mvent_lowtemp             = 10; // in Kelvin
 /*  0 */  "enable/disable channels",
  /*  1 */  "time-dependent heating prohibition in h",
  /*  2 */  "heating switch-on temperature in ",
  /*  3 */  "heating switch-off temperature in ",
  /*  4 */  "minimum temperature in ",
  /*  5 */  "maximum temperature in ",
  /*  6 */  "minimum humidity in %",
  /*  7 */  "maximum humidity in %",
  /*  8 */  "time-dependent ventilation prohibition in h",
  /*  9 */  "high ext. temp. and time-dependent ventilation prohibition in h",
  /* 10 */  "low ext. temp. and time-dependent ventilation prohibition in h",
  /* 11 */  "external temperature upper limit in ",
  /* 12 */  "external temperature lower limit in ",
  /* 13 */  "lighting switch-off in h",
  /* 14 */  "lighting switch-on in h",
  /* 15 */  "ventilating switch-off in m",
  /* 16 */  "ventilating switch-on in m"

*/



5. How to get installer package?
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Visit homepage (see later) to download package:

  architecture  operation system        filename
  --------------------------------------------------------
  (all)         (source code)           mm16d-sw-0.1.tar.gz

Download from Github

  $ git clone https://github.com/pozsarzs/mm16d-sw.git

4. Contact
~~~~~~~~~~
   Homepage:             <http://www.pozsarzs.hu>
   Author:               Pozsar Zsolt
   E-mail:               <pozsarzs@gmail.com>
   Phone:                +36 56/470-272
   Mobile:               +36 30/249-5030

--------------------------------------------------------------------------------
 MM16D * Copyright (C) 2023 Pozsar Zsolt <pozsarzs@gmail.com>
